# By default, the build is done against the running kernel version.
# to build against a different kernel version, set KVER
#
#  make KVER=2.6.11-alpha

ifneq ($(KERNELRELEASE),)
include $(src)/Kbuild
else
CONFIG := CONFIG_VIDEO_IVTV=m

MDIR := ivtv
PWD  := $(shell pwd)
KVER ?= $(shell uname -r)
KDIR := /lib/modules/$(KVER)/build
MODULESDIR = /lib/modules
INSTALL_INIT_FILES = ../ivtv_init_mpeg.bin

# Note: building external modules for a 2.6 kernel causes 'has no CRC' warnings
# to be generated. These messages are harmless but cannot be suppressed.
all:
	$(MAKE) $(CONFIG) -C $(KDIR) M=$(PWD) modules
	@echo
	@echo "Any 'has no CRC' warnings are harmless and can be ignored."
	@echo

install: all
	$(MAKE) INSTALL_MOD_PATH=$(DESTDIR) INSTALL_MOD_DIR=$(MDIR) \
		$(CONFIG) -C $(KDIR) M=$(PWD) modules_install
	@ for m in ` find /lib/modules/$(KVER)/kernel -name msp3400.ko -o -name tuner.ko -o -name tda9887.ko -o -name tveeprom.ko ` ; \
	  do \
	  	if ! cmp -s $$m `basename $$m` ; \
		then \
			echo "Module $$m conflicts with the ivtv module of the same name -- please hide or delete it." ; \
			echo "To hide:  mv $$m $$m.HIDE" ; \
			echo "You will then need to run depmod." ; \
		fi ; \
	  done
ifdef HP_FWLOAD
	@echo ""
	@echo "ivtv_init_mpeg.bin needs copying to the hotplug firmware directory if needed for pvr350 mpeg initialisation"
else
	install -m 0644 $(INSTALL_INIT_FILES) $(DESTDIR)/$(MODULESDIR)
endif

clean::
	rm -rf .*.cmd *.o *.mod.c *.ko .tmp_versions

endif
