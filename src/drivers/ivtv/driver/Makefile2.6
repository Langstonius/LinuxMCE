ifneq ($(KERNELRELEASE),)
include $(src)/Kbuild
else
CONFIG := CONFIG_VIDEO_IVTV=m

MDIR := ivtv
PWD  := $(shell pwd)
KVER := $(shell uname -r)
KDIR := /lib/modules/$(KVER)/build

HEADERDIR = /usr/include/linux
INSTALL_HEADERS = ivtv.h

# Note: building external modules for a 2.6 kernel causes 'has no CRC' warnings
# to be generated. These messages are harmless but cannot be suppressed.
all:
	$(MAKE) $(CONFIG) -C $(KDIR) M=$(PWD) modules
	@echo
	@echo "Any 'has no CRC' warnings are harmless and can be ignored."
	@echo

install: all
	$(MAKE) INSTALL_MOD_PATH=$(DESTDIR) INSTALL_MOD_DIR=$(MDIR) \
		$(CONFIG) -C $(KDIR) M=$(PWD) modules_install
	mkdir -p $(DESTDIR)/$(HEADERDIR)
	install -m 0644 $(INSTALL_HEADERS) $(DESTDIR)/$(HEADERDIR)
	@msp=/lib/modules/$(KVER)/kernel/drivers/media/video/msp3400.ko ; \
	 if [ -f $$msp ]; then \
		echo "You appear to have a $$msp."; \
		echo "That can cause a conflict with the msp3400.ko from ivtv."; \
		echo "It is wise to remove $$msp."; \
		echo "After that run depmod again."; \
	 fi

clean: 
	rm -rf .*.cmd *.o *.mod.c *.ko *~ core .tmp_versions

reload:
	-sudo rmmod ivtv-fb ivtv msp3400 saa7115 saa7127 tuner
	sync
	-sudo modprobe i2c-core
	-sudo modprobe i2c-algo-bit
	-sudo insmod saa7115.ko
	-sudo insmod msp3400.ko
	-sudo modprobe tuner type=29
	-sudo modprobe videodev
	-sudo insmod ivtv.ko ivtv_debug=255

unload:
	-sudo rmmod ivtv-fb ivtv msp3400 saa7115 saa7127 tuner

endif
