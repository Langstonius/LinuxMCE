#!/usr/bin/make -f
# -*- makefile -*-
# Sample debian/rules that uses debhelper.
#
# This file was originally written by Joey Hess and Craig Small.
# As a special exception, when this file is copied by dh-make into a
# dh-make output file, you may use that output file without restriction.
# This special exception was added by Craig Small in version 0.37 of dh-make.
#
# Modified to make a template file for a multi-binary package with separated
# build-arch and build-indep targets  by Bill Allombert 2001

# Uncomment this to turn on verbose mode.
# export DH_VERBOSE=1


# This has to be exported to make some magic below work.
export DH_OPTIONS

-include /usr/share/dpatch/dpatch.make

PACKAGE=freepbx

# this hacks are been done for get-orig-source
DEBVERSION	:= $(shell head -n 1 debian/changelog | sed -e 's/^[^(]*(\([^)]*\)).*/\1/')
UPVERSION	:= $(shell echo $(DEBVERSION) | sed -e 's/^.*://' -e 's/-[0-9.]*$$//' -e 's/.dfsg$$//')
UPFILENAME	:= $(PACKAGE)_$(UPVERSION).orig.tar.gz
DEBFILENAME	:= $(PACKAGE)_$(UPVERSION)~dfsg.orig.tar.gz

#SITE:= http://surfnet.dl.sourceforge.net/sourceforge/amportal
#SITE:= http://jaist.dl.sourceforge.net/sourceforge/amportal
#SITE:= http://switch.dl.sourceforge.net/sourceforge/amportal
#SITE:= http://kent.dl.sourceforge.net/sourceforge/amportal
#SITE:= http://belnet.dl.sourceforge.net/sourceforge/amportal
#SITE:= http://ovh.dl.sourceforge.net/sourceforge/amportal
#SITE:= http://ufpr.dl.sourceforge.net/sourceforge/amportal
#SITE:= http://puzzle.dl.sourceforge.net/sourceforge/amportal
#SITE:= http://superb-east.dl.sourceforge.net/sourceforge/amportal

SITE:= http://mirror.freepbx.org
URL:= $(SITE)/$(PACKAGE)-$(UPVERSION).tar.gz

configure: configure-stamp
configure-stamp:
	touch configure-stamp

# this is done, since we patch the original files with binaries
# the trick is to package the patches as uuencoded text,
# and then on the build stage decode them
%: %.uu
	uudecode --output-file=$@ $<

IMAGES_BASE:=xorcom.png xorcom-ts1.png xorcom-rapid.png
IMAGES:=$(IMAGES_BASE:%=debian/share/%)

build: build-stamp
build-stamp: patch-stamp
build-indep: 
build-arch:

clean: clean-unpatched unpatch
clean-unpatched:
	dh_clean
	dh_testdir
	dh_testroot
	rm -f build-arch-stamp build-indep-stamp #CONFIGURE-STAMP#
	rm -f $(IMAGES)
	dh_clean 


install: install-indep
install-indep: $(IMAGES)
	dh_testdir
	dh_testroot
	dh_clean -k -i 	
	dh_installdirs -i
	dh_install -i
	
	dh_link -p freepbx-common usr/share/freepbx/		usr/share/freepbx/admin
	dh_link -p freepbx-panel usr/share/op-panel/flash	usr/share/freepbx/panel
	dh_link -p freepbx-common usr/share/freepbx/		var/www/freepbx

#	this file is only part of freepbx-admin, no need to install it on the configuration package
	rm -f debian/asterisk-config-freepbx/etc/asterisk/manager.d/freepbx.conf

#	these 3 are in separate packages
	rm -f debian/freepbx-common/usr/share/freepbx/reports.php
	rm -f debian/freepbx-common/usr/share/freepbx/panel.php
	rm -f debian/freepbx-common/usr/share/freepbx/views/panel.php

#	lets clean up the updates dir... deb keeps track of those things
	rm -f debian/freepbx-common/usr/share/freepbx/admin/i18n/*.txt
	rm -f debian/freepbx-common/usr/share/freepbx-common/upgrades/*.md5
	rm -f debian/freepbx-common/usr/share/freepbx-common/upgrades/md5-amp_conf.sh

# 	lame...
	rm -f debian/freepbx-common/usr/share/freepbx-common/upgrades/2.3.0beta1/core_migrate.php
	rm -f debian/freepbx-common/usr/share/freepbx-common/upgrades/2.3.0rc1/removefiles.php
	rm -f debian/freepbx-common/usr/share/freepbx-common/upgrades/2.3.0/removefiles.php

#	lintian fixes
	chmod +x debian/freepbx-common/usr/share/asterisk/bin/freepbx-enable-all-modules
	chmod +x debian/freepbx-common/usr/share/freepbx-common/freepbx-post-reload
	chmod -x debian/freepbx-common/usr/share/freepbx-common/libfreepbx.install.php
	chmod -x debian/freepbx-common/usr/share/asterisk/bin/libfreepbx.confgen.php
	chmod +x debian/freepbx-{sqlite3,mysql}/usr/share/freepbx-common/remove-sql
	chmod +x debian/freepbx-{sqlite3,mysql}/usr/share/freepbx-common/install-sql
	cp debian/freepbx-common.lintian  $(CURDIR)/debian/freepbx-common/usr/share/lintian/overrides/freepbx-common
#	chmod +x debian/freepbx-common/usr/sbin/update-freepbx

# Must not depend on anything. This is to be called by
# binary-arch/binary-indep
# in another 'make' thread.
binary-common:
	dh_testdir
	dh_testroot
	dh_installchangelogs CHANGES
	dh_installdocs
	dh_installexamples
	dh_installinit
	dh_link
	dh_compress
	dh_fixperms
	dh_perl
	dh_installdeb
	dh_shlibdeps
	dh_gencontrol
	dh_md5sums
	dh_builddeb


# Build architecture independant packages using the common target.
binary-indep: build-indep install-indep
	$(MAKE) -f debian/rules DH_OPTIONS=-i binary-common


# Build architecture dependant packages using the common target.
#binary-arch: build-arch install-arch
#	$(MAKE) -f debian/rules DH_OPTIONS=-a binary-common

upstream: get-orig-source
get-orig-source:
	@@dh_testdir
	@@[ -d ../tarballs/. ]||mkdir -p ../tarballs
	@@echo Downloading $(UPFILENAME) from $(URL) ...
	wget -N  -T10 -t3 -O ../tarballs/$(UPFILENAME) $(URL)

	tar xfz ../tarballs/$(UPFILENAME)
	mv $(PACKAGE)-$(UPVERSION) $(PACKAGE)-$(UPVERSION).tmp

# jpgraph is problematic
	rm -f  $(PACKAGE)-$(UPVERSION).tmp/amp_conf/htdocs/admin/reports.php
	rm -fr $(PACKAGE)-$(UPVERSION).tmp/amp_conf/htdocs/admin/cdr

# op-panel should not be part of this package
	ls $(PACKAGE)-$(UPVERSION).tmp/amp_conf/htdocs_panel/* | egrep -v '\.php|\.cfg' | xargs rm -f

# ari has it's own package
	rm -fr $(PACKAGE)-$(UPVERSION).tmp/amp_conf/htdocs/recordings

# modules have their own pachage
	rm -fr $(PACKAGE)-$(UPVERSION).tmp/amp_conf/htdocs/admin/modules/core/
	rm -fr $(PACKAGE)-$(UPVERSION).tmp/amp_conf/htdocs/admin/modules/dashboard/
	rm -fr $(PACKAGE)-$(UPVERSION).tmp/amp_conf/htdocs/admin/modules/featurecodeadmin/
	rm -fr $(PACKAGE)-$(UPVERSION).tmp/amp_conf/htdocs/admin/modules/framework/
	rm -fr $(PACKAGE)-$(UPVERSION).tmp/amp_conf/htdocs/admin/modules/infoservices/
	rm -fr $(PACKAGE)-$(UPVERSION).tmp/amp_conf/htdocs/admin/modules/music/
	rm -fr $(PACKAGE)-$(UPVERSION).tmp/amp_conf/htdocs/admin/modules/recordings/
	rm -fr $(PACKAGE)-$(UPVERSION).tmp/amp_conf/htdocs/admin/modules/voicemail/

# repackage the new source
	cd $(PACKAGE)-$(UPVERSION).tmp ; \
	mkdir $(PACKAGE)_$(UPVERSION).dfsg;\
	mv -f * $(PACKAGE)_$(UPVERSION).dfsg; \
	tar cfz ../$(DEBFILENAME) *
	mv -f $(DEBFILENAME) ../tarballs
	echo Cleaning up...
	$(RM) -rf $(PACKAGE)-$(UPVERSION).tmp/

binary: binary-indep
.PHONY: build clean binary-indep binary-arch binary install install-indep install-arch configure patch unpatch
