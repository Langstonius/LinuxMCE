#!/usr/bin/make -f
# -*- makefile -*-

# Uncomment this to turn on verbose mode.
#export DH_VERBOSE=1

# This has to be exported to make some magic below work.
export DH_OPTIONS

include /usr/share/dpatch/dpatch.make

PKG := ivtv

# prefix of the target package name
PACKAGE=$(PKG)-modules
# modifieable for experiments or debugging m-a
MA_DIR ?= /usr/share/modass
# load generic variable handling
-include $(MA_DIR)/include/generic.make
# load default rules
-include $(MA_DIR)/include/common-rules.make

CFLAGS = -Wall -g

CURDIR := $(shell pwd)

DEB_BUILD_ARCH := $(shell dpkg-architecture -qDEB_BUILD_ARCH)

ifneq (,$(findstring noopt,$(DEB_BUILD_OPTIONS)))
	CFLAGS += -O0
else
	CFLAGS += -O2
endif

DEBVERSION:=$(shell head -n 1 debian/changelog \
                    | sed -e 's/^[^(]*(\([^)]*\)).*/\1/')
UPVERSION:=$(shell echo $(DEBVERSION) | sed -e 's/^.*://' -e 's/-[0-9.]*$$//' -e 's/.dfsg$$//')

FILENAME := ivtv_$(UPVERSION).dfsg.orig.tar.gz
UPFILENAME := ivtv_$(UPVERSION).orig.tar.gz
URL := http://dl.ivtvdriver.org/ivtv/archive/0.7.x/ivtv-$(UPVERSION).tar.gz

configure: patch configure-stamp
configure-stamp:
	dh_testdir
	touch configure-stamp


#Architecture 
build: build-arch build-indep

build-arch: build-arch-stamp
build-arch-stamp: configure
	$(MAKE) -C utils
	touch build-arch-stamp

build-indep: build-indep-stamp
build-indep-stamp: configure
	touch build-indep-stamp

clean: clean-patched unpatch
clean-patched:
	dh_testdir
	dh_testroot
	rm -f build-arch-stamp build-indep-stamp configure-stamp

	-$(MAKE) -C utils clean

	dh_clean 

install: install-indep install-arch
install-indep:
	dh_testdir
	dh_testroot
	dh_clean -k -i 
	dh_installdirs -i usr/src/modules/$(PKG)

	mkdir -p debian/$(PKG)-source$(MA_DIR)/packages/
	cd debian/$(PKG)-source$(MA_DIR)/packages/ && ln -sf default.sh $(PKG)-source
	mkdir -p debian/$(PKG)-source/usr/src/modules/$(PKG)/driver
	mkdir -p debian/$(PKG)-source/usr/src/modules/$(PKG)/i2c-drivers
	cp -a driver/* debian/$(PKG)-source/usr/src/modules/$(PKG)/driver
	cp -a i2c-drivers/* debian/$(PKG)-source/usr/src/modules/$(PKG)/i2c-drivers
	mkdir debian/$(PKG)-source/usr/src/modules/$(PKG)/debian
	cd debian ; cp changelog control compat *.modules.in rules copyright \
		$(PKG)-source/usr/src/modules/$(PKG)/debian
	cd debian/$(PKG)-source/usr/src/ ; \
		tar -c modules | bzip2 -9 > $(PKG)-source.tar.bz2 && \
		rm -rf modules
	dh_install -i

install-arch:
	dh_testdir
	dh_testroot
	dh_clean -k -s 
	dh_installdirs -s

	$(MAKE) -C utils install DESTDIR=$(CURDIR)/debian/$(PKG)-utils PREFIX=/usr
	cp utils/ivtvfwextract.pl debian/$(PKG)-utils/usr/bin/ivtvfwextract
	cp utils/perl/ptune.pl  debian/$(PKG)-utils/usr/bin/ptune
	cp utils/perl/ptune-ui.pl  debian/$(PKG)-utils/usr/bin/ptune-ui
	#cp v4l-cx2341x-init.mpg debian/$(PKG)-utils/lib/firmware/v4l-cx2341x-init.mpg
	cd debian/$(PKG)-utils/lib/firmware/ && ln -sf v4l-cx2341x-init.mpg v4l-cx2341x-init-mpeg.bin
	sed -e 's/@VERSION@/$(VERSION)/g'	\
	    -e 's/@PKG@/$(PKG)/g'		\
		< debian/ivtv-make-fwpkg.in	\
		> debian/$(PKG)-utils/usr/bin/ivtv-make-fwpkg
	chmod +x debian/$(PKG)-utils/usr/bin/ivtv-make-fwpkg

# Must not depend on anything. This is to be called by
# binary-arch/binary-indep
# in another 'make' thread.
binary-common:
	dh_testdir
	dh_testroot
	dh_installchangelogs ChangeLog
	dh_installdocs
	dh_installexamples
	dh_installman
	dh_link
	dh_strip
	dh_perl
	dh_compress 
	dh_fixperms
	dh_makeshlibs
	dh_installdeb
	dh_shlibdeps
	dh_gencontrol
	dh_md5sums
	dh_builddeb

# Build architecture independant packages using the common target.
binary-indep: build-indep install-indep
	$(MAKE) -f debian/rules DH_OPTIONS=-i binary-common

# Build architecture dependant packages using the common target.
binary-arch: build-arch install-arch
	$(MAKE) -f debian/rules DH_OPTIONS=-a binary-common

binary: binary-arch binary-indep
.PHONY: build clean binary-indep binary-arch binary install install-indep install-arch configure

KMAKE := $(MAKE) KVER=$(KVERS) KDIR=$(KSRC) HP_FWLOAD=1 DEBIAN_MAKE_KPKG=1

kdist_clean:
	dh_clean
	$(KMAKE) -C driver clean
	$(KMAKE) -C i2c-drivers clean

kdist_config: prep-deb-files

kdist_configure: kdist_config

binary-modules: prep-deb-files
	dh_testdir
	dh_testroot
	dh_clean -k
	$(KMAKE) -C driver
	$(KMAKE) -C i2c-drivers
	$(KMAKE) -C driver install DESTDIR=$(CURDIR)/debian/$(PKGNAME)
	$(KMAKE) -C i2c-drivers install DESTDIR=$(CURDIR)/debian/$(PKGNAME)
	dh_installmodules 
	dh_installdocs
	dh_installchangelogs
	dh_compress
	dh_fixperms
	dh_installdeb
	dh_gencontrol -- -v$(VERSION)
	dh_md5sums
	dh_builddeb --destdir=$(DEB_DESTDIR)

print-version:
	@@echo "Debian version:          $(DEBVERSION)"
	@@echo "Upstream version:        $(UPVERSION)"

get-orig-source:
	@@dh_testdir
	@@[ -d ../tarballs/. ]||mkdir -p ../tarballs
	@@echo Downloading $(UPFILENAME) from $(URL) ...
	@@wget -N -nv -T10 -t3 -O ../tarballs/$(UPFILENAME) $(URL)


