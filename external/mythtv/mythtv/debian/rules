#!/usr/bin/make -f
# Sample debian/rules that uses debhelper. 
# GNU copyright 1997 by Joey Hess.
#
# This version is for a hypothetical package that builds an
# architecture-dependant package, as well as an architecture-independent
# package.

# Uncomment this to turn on verbose mode. 
#export DH_VERBOSE=1

# This is the debhelper compatibility version to use.
export DH_COMPAT=3

export QTDIR=$(shell for qtdir in /usr/share/qt3 /usr/share/qt; do if test -d $$qtdir; then echo $$qtdir; break; fi; done)

CCVARS=CC=gcc-3.3 CXX=g++-3.3 LINK=g++-3.3

config.mak: configure
	dh_testdir

	if [ $$PWD != $${PWD#/usr} ]; then \
		echo "You must not build this package under /usr due to Debian bug #180240" >&2; \
		exit 1; \
	fi

	$(CCVARS) ./configure --prefix=/usr \
		--cpu=i486 --tune=pentium4 --enable-mmx \
		--enable-lirc \
		--enable-audio-alsa \
		--enable-audio-oss \
		--enable-audio-jack \
		--enable-audio-arts \
		--enable-opengl-vsync \
		--enable-dvb \
		--dvb-path=/usr/include \
		--enable-firewire \
		--enable-ivtv \
		--enable-joystick-menu \
		--enable-proc-opt

	$(CCVARS) qmake -o Makefile PREFIX=/usr mythtv.pro

build-arch:  config.mak build-arch-stamp
build-arch-stamp:
	dh_testdir

	$(MAKE) $(CCVARS)
	chmod +rx debian/mythsql

	touch build-arch-stamp

build-indep: build-indep-stamp
build-indep-stamp:
	dh_testdir

	touch build-indep-stamp

build: build-arch build-indep

clean:
	dh_testdir
	dh_testroot
	rm -f build-arch-stamp build-indep-stamp 

	# Add here commands to clean up after the build process.
	-$(MAKE) distclean
	find . -name '.qmake*' | xargs --no-run-if-empty rm -f
	rm -f config.mak config.h
	rm -rf debian/shlibs.local

	dh_clean

install: DH_OPTIONS=
install: build
	dh_testdir
	dh_testroot
	dh_clean -k
	dh_installdirs -pmythtv-backend etc/mythtv var/lib/mythtv var/cache/mythtv var/log/mythtv
	dh_installdirs -pmythtv-common etc/mythtv
	dh_installdirs -pmythtv-frontend etc/mythtv
	dh_install -pmythtv-common debian/mysql.txt.dist usr/share/mythtv

	rm -rf $(CURDIR)/debian/tmp
	$(MAKE) install INSTALL_ROOT=$(CURDIR)/debian/tmp/

	install -d debian/tmp/usr/share/mythtv/sql
	install -m 644 database/*.sql debian/tmp/usr/share/mythtv/sql

	dh_strip -pmythtv --tmpdir=debian/tmp --keep-debug
	rm -f debian/tmp/usr/share/mythtv/FreeSans.ttf debian/tmp/usr/share/mythtv/FreeMono.ttf
	dh_link -pmythtv-common usr/share/fonts/truetype/freefont/FreeSans.ttf usr/share/mythtv/FreeSans.ttf
	dh_link -pmythtv-common usr/share/fonts/truetype/freefont/FreeMono.ttf usr/share/mythtv/FreeMono.ttf

	dh_install --sourcedir=debian/tmp -pmythtv-backend usr/share/mythtv/setup.xml
	rm -f debian/tmp/usr/share/mythtv/setup.xml
	dh_movefiles --sourcedir=debian/tmp

	dh_install -pmythtv-common debian/mythsql usr/share/mythtv

	# Autogenerated configuration files
	set -e; \
	for cf in debian/mythtv-common/usr/share/mythtv/mysql.txt; do \
		ln -s /etc/mythtv/`basename $$cf` $$cf; \
	done

# Build architecture-independent files here.
# Pass -i to all debhelper commands in this target to reduce clutter.
binary-indep: build install
	dh_testdir -i
	dh_testroot -i
	dh_installdebconf -i
	dh_installdocs -A README debian/README.Debian AUTHORS FAQ UPGRADING keys.txt
	dh_installdocs -pmythtv-doc docs/mythtv-HOWTO*
	dh_installexamples -pmythtv-doc configfiles/*
#	dh_installman -i
#	dh_undocumented -i
	dh_installchangelogs  -i
	dh_link -i
	dh_compress -i
	dh_fixperms -i
	dh_installdeb -i
	dh_gencontrol -i
	dh_md5sums -i
	dh_builddeb -i

# Build architecture-dependent files here.
binary-arch: build install
	dh_testdir -a
	dh_testroot -a
	dh_installdocs -a -A README debian/README.Debian AUTHORS keys.txt FAQ UPGRADING
	dh_installdebconf -a
	dh_installexamples -a
	dh_installmenu -a
	dh_installlogrotate -a
#	dh_installemacsen -a
#	dh_installpam -a
#	dh_installmime -a
	dh_installinit -a
	dh_installcron -a
#	dh_installman -a
	dh_installinfo -a
#	dh_undocumented -a
	dh_installchangelogs  -a
	dh_strip -a -Xusr/lib/debug
	dh_link -a
	dh_compress -a
	dh_fixperms -a
	dh_makeshlibs -a -Xusr/lib/mythtv/filters
	dh_installdeb -a
	# Don't use dh_shlibdeps -L just yet, so we can build on woody easily
	cp debian/libmyth-0.18.1/DEBIAN/shlibs debian/shlibs.local
	dh_shlibdeps -a -ldebian/libmyth-0.18.1/usr/lib
	dh_gencontrol -a
	dh_md5sums -a
	dh_builddeb -a

binary: binary-indep binary-arch
.PHONY: build clean binary-indep binary-arch binary install 
