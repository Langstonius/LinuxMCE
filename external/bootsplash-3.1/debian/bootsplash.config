#!/bin/bash

set -e

# source debconf stuff
. /usr/share/debconf/confmodule

THEME_SYMLINK="/etc/bootsplash/themes/current"

# get and save the current theme, ignore errors
db_get shared/bootsplash-theme || true
OLD_DEFAULT="$RET"

# get the owners and the choices for this option
db_metaget shared/bootsplash-theme owners
OWNERS="$RET"

db_subst shared/bootsplash-theme choices $OWNERS

# input the desired theme
db_input medium shared/bootsplash-theme || true
db_go

# get the new default theme
db_get shared/bootsplash-theme
NEW_DEFAULT="$RET"

# locate initrd images and add none and custom to the list
db_subst shared/bootsplash-initrd initrd-list `echo none all custom /boot/initrd* | sed -e 's/ /, /g;'`
db_input medium shared/bootsplash-initrd || true
db_go

db_get shared/bootsplash-initrd
INITRD="$RET"

if [ "$INITRD" = "custom" ]
then
   db_input medium shared/bootsplash-custom-initrd || true
   db_go
fi

# don't ask which resoultion if there is only one choice

db_metaget $NEW_DEFAULT/resolutions choices
RES=($RET)

if [ ${#RES[*]} -ne 1 ]
then
   # input the desired resolutions
   db_input medium $NEW_DEFAULT/resolutions || true
   db_go
fi

db_get $NEW_DEFAULT/resolutions
NEW_RES="$RET"

if [ "$NEW_DEFAULT" != "$OLD_DEFAULT" ]
then
   rm -f $THEME_SYMLINK || true
elif [ "$NEW_RES" != "$OLD_RES" ]
then
   rm -f $THEME_SYMLINK || true
fi

db_input medium shared/bootsplash-bootloader || true
db_go

exit 0
