#!/bin/bash

function box() { true; }
test -f "/etc/bootsplash/themes/current/config/bootsplash-`/sbin/fbresolution`.cfg" && . /etc/bootsplash/themes/current/config/bootsplash-`/sbin/fbresolution`.cfg

Message() {
    echo -e "\033[1m# $*"
    tput sgr0

    # Update boot splash progress bar
    progress=$(( $progress + 1 ))

    grep -q "silent" /proc/splash 2>/dev/null
    if [[ $? -eq 0 ]] ;then
        echo "show $(( 65534 * ( $progress + 1 ) / 20 ))" > /proc/splash
        if [ "$text_x" != "" -a "$text_y" != "" -a "$text_color" != "" -a "$text_size" != "" ] ;then
            text_font="/etc/bootsplash/fonts/VeraBd.ttf"
            /sbin/fbtruetype -x$(($text_x + 1)) -y$(($text_y + 1)) -t000000 -s$text_size -f$text_font "$*"
            /sbin/fbtruetype -x$text_x -y$text_y -t$text_color -s$text_size -f$text_font "$*"
        fi
    fi
}

InitBootsplash() {
    progress=0
    kscripts=0
    sscripts=25
    export progress kscripts sscripts
}

## Some defaults
PATH=/sbin:/usr/sbin:/bin:/usr/bin
runlevel=S
prevlevel=N
umask 022
export PATH runlevel prevlevel
InitBootsplash

## Mount the proc filesystem
Message "Mounting /proc filesystem"
/bin/mount -v proc /proc -n -t proc

## Mount the sysfs, if the kernel supports it
Message "Mounting /sys filesystem"
if [ -d /sys ] ;then
	if cat /proc/filesystems | grep -w sysfs 1> /dev/null 2> /dev/null ;then
		if ! cat /proc/mounts | grep -w sysfs 1> /dev/null 2> /dev/null ;then
			/bin/mount -v sysfs /sys -n -t sysfs
		fi
	fi
fi

## Initalize udev
Message "Initializing udev"
/etc/init.d/udev start 1>/dev/null

## Loading modules
Message "Loading modules"
(cat /etc/modules; echo) | # make sure there is a LF at the end
while read module args
do
        case "$module" in
                \#*|"") continue ;;
        esac
        modprobe $module $args
done

## Initializing coldplug system (lshwd or hotplug)
Message "Loading coldplug modules"
if [ -x /etc/init.d/hotplug ] ;then
	/etc/init.d/hotplug start
elif [ -x /usr/bin/lshwd ] ;then
	/usr/bin/lshwd -a > /dev/null
	/usr/bin/lshwd
	# mousedev doesn't autoload, so we use hotplug for input to be safe
	/etc/hotplug/input.rc start >/dev/null
fi

## Enableing RAID devices
if [[ -x /etc/init.d/mdadm ]]; then
	/etc/init.d/mdadm start
	/etc/init.d/mdadm-raid start
fi

## Enable Swaping
Message "Enable swaping"
/sbin/swapon -a > /dev/null


## Check Filesystem
Message "Checkeing Filesystem"
#etc/init.d/checkroot.sh start
grep -qi " fsck " /proc/cmdline || grep -qi " fsck$" /proc/cmdline
fsckRequested=$?
if [[ ! -f /fastboot || $fsckRequested -eq 0 ]] ;then
	if [[ -f /forcefsck || $fsckRequested -eq 0 ]] ;then
		force='-f'
	else
		force=''
	fi

	fsck -C -A -a $force 

	if [ $? -gt 1 ] ;then
		echo
		echo "fsck failed. Please repair manualy."
		echo
		echo "CONTROL-D will exit form this shell and continue system startup."
		echo

		/sbin/sulogin 
	fi
fi
rm -f /fastboot /forcefsck

## Clean up the /etc/mtab
Message "Cleaning up /etc/mtab"
/bin/mount -w -o remount /
/bin/rm -rf /etc/mtab* 2>/dev/null

# Do a remount one again so it will show up in mtab
/bin/mount -w -o remount /


if [ -d /proc/sys ] ;then
	/bin/mount -f proc /proc -t proc
fi
if [ -d /sys/bus ] ;then
	/bin/mount -f sysfs /sys -t sysfs
fi
/etc/init.d/udev-mtab start > /dev/null

## Seting up the system time from the hardware clock
Message "Setting up the system time from the hardware clock"
. /etc/default/rcS #FIXME: Should i put it on a separate config file ?
if [ "$UTC" == "yes" ] ;then
	/sbin/hwclock --utc --hctosys > /dev/null
else 
	/sbin/hwclock --localtime --hctosys > /dev/null
fi

## Do some pluto specific cleanup
setterm -blank >/dev/console             # disable console blanking
chmod 777 /etc/pluto.conf                # ensure access rights on pluto.conf
rm /var/log/pluto/running.pids
chmod 777 /var/log/pluto
rm -f /dev/ttyS_*                        # remove all ttyS_* (created by gc100s) entries from /dev
mkdir -p /usr/pluto/locks                # clean up locks
rm -f /usr/pluto/locks/*                 # clean up locks
rm -f /etc/rc{0,6}.d/S*{umountnfs.sh,portmap,networking}
dmesg -n 1

## Force some config options to sysklogd
SysLogCfg="*.*;auth,authpriv.none       /dev/tty12"
if ! grep -qF "$SysLogCfg" /etc/syslog.conf; then
        echo "$SysLogCfg" >>/etc/syslog.conf
fi
if ! grep -q '^SYSLOGD="-r"$' /etc/init.d/sysklogd; then
	sed -i 's/^SYSLOGD=.*$/SYSLOGD="-r"/' /etc/init.d/sysklogd
fi


. /usr/pluto/bin/Config_Ops.sh
. /usr/pluto/bin/pluto.func
. /usr/pluto/bin/SQL_Ops.sh

if [[ -e /usr/pluto/install/.notdone ]]; then
    Logging "$TYPE" "$SEVERITY_CRITICAL" "$0" "It appears the installation was not successful. Pluto's startup scripts are disabled. To enable them, complete the installation process, or manually remove the file /usr/pluto/install/.notdone"
fi

## Configure runtime kernel parameters
Message "Configuring runtime kernel parameters"
if [ -x /sbin/sysctl -a -r /etc/sysclt.conf ] ;then 
	/sbin/sysctl -e -p /etc/sysctl.conf > /dev/null
fi

## Check all non-root filesystems
Message "Check/Mount all local non-root filesystems"
if [ ! -r /etc/fastboot  ]; then
	/sbin/fsck $force -C -R -A -a
fi

## Mount all local non root filsystems except /proc witch was allready mounted
/bin/mount -a -v -t nonfs,nosmbfs,noproc > /dev/null

## Create /tmp/{.ICE-unix, .X11-unix} if they are not present
find /tmp -maxdepth 1 -mindepth 1 -print0 | xargs -0 rm -rf

if [ ! -e /tmp/.ICE-unix ] ;then
	mkdir -p /tmp/.ICE-unix 
	chmod 1777 /tmp/.ICE-unix
fi
if [ ! -e /tmp/.X11-unix ] ;then
	mkdir -p /tmp/.X11-unix
	chmod 1777 /tmp/.X11-unix
fi

## Umount and remove prosible /initrd
if [ -d /initrd ] ;then
	umount /initrd/proc 2> /dev/null
	/bin/umount /initrd 2> /dev/null
	rmdir /initrd 2> /dev/null
	blockdev --flushbufs /dev/ram0 2> /dev/null
fi

## Create a fresh utmp file
touch /var/run/utmp
chown root.utmp /var/run/utmp
chmod  664 /var/run/utmp

## Set up the hostname
Message "Setting up the hostname"
if [ -f /etc/hostname ] ;then
	hostname --file /etc/hostname
fi

## Start up the networking
Message "Start up networking"
if [[ -x /etc/init.d/ifupdown-clean ]]; then
	/etc/init.d/ifupdown-clean start 1> /dev/null
fi
if [[ -x /etc/init.d/ifupdown ]]; then
	/etc/init.d/ifupdown start 1> /dev/null # Remove when droping the 
fi
if [[ -x /etc/init.d/networking ]]; then
	/etc/init.d/networking start 1> /dev/null # Uptate_Packages script ?
fi
if [[ -x /etc/init.d/inetd ]]; then
	/etc/init.d/inetd start 1> /dev/null # Starts tftp on Core and Hybrid
fi
if [[ -x /etc/init.d/portmap ]]; then
	/etc/init.d/portmap start 1> /dev/null # Search me ! :/
fi

## Now we can safely mount remoute filesystems
Message "Mounting remote filesystems"
/etc/init.d/mountnfs.sh start 1> /dev/null


## Check to see if a single mode was requested
grep -qi " s " /proc/cmdline || grep -qi " s$" /proc/cmdline
if [[ $? -eq 0 ]]; then
	rm -f /var/run/block_single
	Message "Going into single user mode"
	/sbin/sulogin
	touch /var/run/block_single
fi

## Start a the ssh daemon very early
if [[ -x /etc/init.d/ssh ]] ;then
	Message "Starting Secure Shell Daemon";
	/etc/init.d/ssh start &
fi

## Start RemoteAccess at this step
if [[ -x /usr/pluto/bin/SetupRemoteAccess.sh ]]; then
	Message "Checking/Activating Remove Access"
	/usr/pluto/bin/SetupRemoteAccess.sh &
fi

# A hack ?
if [ -x /etc/init.d/mysql ] ;then
    Message "Starting mysql server"
    /etc/init.d/mysql start 2>/dev/null
fi


# assure some settings
if [[ -x /usr/pluto/bin/Report_Machine_Status.sh ]]; then
	/usr/pluto/bin/Report_Machine_Status.sh  &
fi
Q="SELECT FK_Installation FROM Device WHERE PK_Device='$PK_Device'"
R="$(RunSQL "$Q")"
ConfSet PK_Installation "$R"
Q="SELECT PK_Users FROM Users LIMIT 1"
R="$(RunSQL "$Q")"
ConfSet PK_Users "$R"


if [[ -f /usr/pluto/bin/Config_Ops.sh ]]; then
	 /usr/pluto/bin/Config_Ops.sh
fi

if [[ "$FirstBoot" != "false" && ! -f /usr/pluto/install/.notdone ]] ;then
	Message "Generating pluto bootscripts for the first time"
	/usr/pluto/bin/generateRcScripts.sh
	ConfSet "FirstBoot" "false"
fi

if [ -x /etc/init.d/Pluto_ConfirmInstallation.sh ] ;then
    Message "Confirm Instalation"
    /etc/init.d/Pluto_ConfirmInstallation.sh
fi

#f [ -x  /etc/init.d/Pluto_Update_Packages.sh ] ;then
#   Message "Checking for Updates"
#   /etc/init.d/Pluto_Update_Packages.sh
#i
if [ -x /usr/pluto/bin/ApplyUpdates.sh ]; then
	Message "Updating system"
	/usr/pluto/bin/ApplyUpdates.sh
fi
	
if [ -x /etc/init.d/Pluto_Start_DCERouter.sh ] ;then
    Message "Starting DCE Router"
    /etc/init.d/Pluto_Start_DCERouter.sh
fi

if [ -x /usr/pluto/bin/PlutoHalDaemon.sh ] ;then
	Message "Starting Pluto Hal Daemon"
	/usr/pluto/bin/PlutoHalDaemon.sh
fi

if [ -x /etc/init.d/Pluto_Start_OrbiterGen.sh ] ;then
    Message "Starting OrbiterGen"
    /etc/init.d/Pluto_Start_OrbiterGen.sh
fi

if [ -x /etc/init.d/Pluto_Config_Device_Changes.sh ]; then
    Message "Configure Device Changes"
    /etc/init.d/Pluto_Config_Device_Changes.sh
fi

if [ -x /etc/init.d/Pluto_Start_X.sh ] ;then
    Message "Starting X Server"
    /etc/init.d/Pluto_Start_X.sh
fi

if [ -x /etc/init.d/Pluto_Start_LocalDevices.sh ] ;then
    Message "Starting Local Devices"
    /etc/init.d/Pluto_Start_LocalDevices.sh
fi
